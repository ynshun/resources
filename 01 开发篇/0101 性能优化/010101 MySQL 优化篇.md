> 平时工作中一直都有使用到MySQL/Mariadb，但是一直没有系统去学习过，只知其基本的使用；一次在一个技术交流群中看到几个应届毕业生讨论面试情况，才发现自己原来对MySQL知之甚少，遂抽空学习了一下相关知识并整理了本文便于日后查阅；
> **特别申明**：本文并非原创，内容大量借鉴开课吧公开课老师课件。

**学习目标**
* 1、性能分析要从三架马车开始（慢查询日志、explain执行计划、show profile）
* 2、有了性能报告，接下来如何对性能进行优化呢？
* 3、我们一定要搞清楚通过explain显示查询计划中关于索引是否被用到
* 4、你知道MySQL的索引在执行过程中是如何被使用的吗？
* 5、你知道MySQL中的表数据和索引在底层是如何存储的吗？
* 6、你了解聚集索引（IOT索引组织表）和非聚集索引（堆组织表）的存储方式的不同吗？
* 7、你知道聚集索引中的主键索引和辅助索引是如何存储索引和数据的吗？
* 8、你会正确使用组合索引吗？
* 9、你明白最左前缀原则是怎么回事吗？
* 10、你明白什么是索引覆盖吗？索引覆盖如何优化检索性能？
* 11、如何正确使用索引，才不会引起索引失效？

# 1 MySQl 架构篇

## 1.1 MySQL存储引擎种类

| 存储引擎          | 说明                                                         |
| ----------------- | ------------------------------------------------------------ |
| MyISAM            | 高速引擎，拥有较高的插入、查询速度，但不支持事务             |
| InnoDB            | **5.5版本后MySQL的默认引擎，支持事务和行级锁**，比MyISAM处理速度稍慢 |
| ISAM              | MyISAM的前身，MySQL5.0以后不再默认安装                       |
| MRG_MyISAM(MERGE) | 将多个表联合成一个表使用，在超大规模数据存储时很有用         |
| Memory            | **内存储存引擎，拥有极高的插入、更新和查询效率**。但是会占用和数据量成正比的内存空间。只在内存上保存数据，意味着数据可能会丢失。 |
| Falcon            | 一种新的存储引擎，支持事务（传言可能是InnoDB的替代者）       |
| Archive           | 将数据压缩后进行存储，非常适合储存大量的独立的，作为历史记录的数据，但是只能进行插入和查询操作 |
|                   | CSV存储引擎是基于CSV格式文件存储数据（应用于跨平台数据交换） |

## 1.2 InnoDB和MyISAM存储引擎区别

|          | InnoDB                                       | MyISAM                                                |
| -------- | -------------------------------------------- | ----------------------------------------------------- |
| 存储文件 | .frm 表定义文件<br />.ibd 数据文件和索引文件 | .frm 表定义文件<br />.myd 数据文件<br />.myi 索引文件 |
| 锁       | 表锁、行锁                                   | 表锁                                                  |
| 事务     | 支持                                         | 不支持                                                |
| CRUD     | 读、写                                       | 多读                                                  |
| count    | 扫表                                         | 专门存储的地方                                        |
| 索引结构 | B+ Tree                                      | B+ Tree                                               |

## 1.3 物理文件

### 1.3.1 日志文件（顺序IO）

MySQL通过日志记录了数据库操作信息和错误信息，常用的日志文件包括错误日志、二进制日志、查询日志、慢查询日志和事务Redo日志、中继日志等。

#### 1.3.1.1 错误日志（error log）

**默认开启**，而且从5.5.7以后无法关闭错误日志，错误日志记录了运行过程中遇到的所有严重的错误信息，以及MySQL每次启动和关闭的详细信息。

#### 1.3.1.2 二进制日志（bin log）

**默认关闭**，binlog记录了数据库所有的ddl语句和dml语句，但不包括select语句内容，语句以事件的形式保存，扫描了数据的变更顺序，binlog还包括了每个更新语句的执行时间信息。如果是DDL语句，则直接记录到binlog日志，而DML语句必须通过事务提交才能记录到binlog日志中。

binlog主要用于实现MySQL主从复制、数据备份、数据恢复。

#### 1.3.1.3 通用查询日志（general query log）

默认情况下通用日志是关闭的。

#### 1.3.1.4 慢查询日志(slow query log)

默认是关闭的

#### 1.3.1.5 重做日志（redo log）

* 确保事务的持久性
* 防止在发生故障的时间点，尚有脏页未写入磁盘，在重启MySQL服务的时候，根据redo log进行重做，从而达到事务的持久性这一特征。

#### 1.3.1.6 回滚日志（undo log）

保存了事务发生之前的数据的一个版本，可以用于回滚，同时可以提供多版本并发控制下的读（MVCC），也即非锁定读。

#### 1.3.1.7 中继日志

* 是在主从复制环境中产生的日志。
* 主要作用是为了从机可以从中继日志中获取到主机同步过来的SQL语句，然后执行到从机中。

### 1.3.2 数据文件（随机IO）

#### 1.3.2.1 InnoDB数据文件

* .frm文件：主要存放与表相关的数据信息，主要包括表结构的定义信息；
* .ibd文件：使用独享表空间存储表数据和索引信息，一张表对应一个ibd文件；
* ibdata文件：使用共享表空间存储表数据和索引信息，所有表共同使用一个或者多个ibdata文件

#### 1.3.2.2 MyISAM数据文件

* .frm文件：主要存放与表相关的数据信息，主要包括表结构的定义信息；
* .myd文件：主要用于存储表数据信息；
* .myi文件：主要用于存储数据文件中任何索引的数据树。

# 2 MySQL性能分析篇

**思路：**

* 首先需要使用【慢查询日志】功能，去获取所有查询时间比较长的SQL语句
* 其次【查看执行计划】查看有问题的SQL的执行计划
* 最后可以使用【show profile[s]】查看有问题的SQL的性能使用情况

## 2.1 慢查询日志

数据库查询快慢是影响项目性能的一大因素，对于数据库，我们除了要优化SQL，更重要的是得先找到需要优化的SQL，MySQL数据库有一个“慢查询日志”功能，用来记录查询时间超过某个设定值的SQL语句，这将极大程度帮助我们快速定位到症结所在，以便对症下药。

至于查询时间的多少才算慢，每个项目、业务都有不同的要求。

> 比如传统企业的软件允许某查询功能响应时间高于3秒，但是把这个标准放到互联网项目或者访问量大的网站上，估计就是一个bug，甚至可能升级为一个功能性缺陷。

MySQL慢查询日志功能默认是关闭的，需要手动开启。

## 2.2 profile分析语句

Query Profile是MySQL自带的一种query诊断分析工具，通过它可以分析出一条SQL语句的硬件性能瓶颈在什么地方。

通常我们是使用explain，以及slow query log都无法做到精确分析，但是Query Profile却可以定位出一条SQL语句执行的各种资源消耗情况，比如CPU、IO等，以及该SQL执行所海飞的时间等，不过该工具只有再MySQL5.0.37及以上的版本中才有实现。

默认情况下，MySQL的该功能没有打开，需要自己手动启动。

# 3 MySQL索引篇

## 3.1 索引介绍

### 3.1.1 索引是什么

* 高效获取数据的数据结构
* 使用B+ Tree结构（多路搜索树，并不一定是二叉树）
* 索引是存储在磁盘文件中的（可能在单独的索引文件中，也可能和数据一起存储在数据文件中）

### 3.1.2 索引的优势和劣势

#### 3.1.2.1 优势

* **可以提高数据库的效率，降低数据库的IO成本**，类似于书的目录。
* **通过索引列对数据进行排序**，降低数据排序的成本，降低了CPU的消耗。

#### 3.1.2.2 劣势

* 索引会占据磁盘空间
* 索引虽然会提高查询效率，但是会降低更新表的效率

### 3.1.3 常用索引分类

#### 3.1.3.1 单列索引

* 普通索引：MySQL中基本索引类型，没有什么限制，允许在定义索引的列中插入重复值和控制，纯粹为了查询数据更快一点。
* 唯一索引：索引列中的值必须是唯一的，但是允许为空值。
* 主键索引：是一种特殊的唯一索引，不允许有空值。

#### 3.1.3.2 组合索引

* 在表中的多个字段组合上创建的一个索引。
* 组合索引的使用，需要遵循最左前缀原则（最左匹配原则）。
* 一般情况下，建议使用组合索引代替单列索引（主键索引除外）

### 3.1.4 索引的存储结构

#### 3.1.4.1 索引存储结构介绍

* 索引是在存储引擎中实现的。
* MyISAM和InnoDB存储引擎：只支持BTREE索引，也就是说默认使用BTREE，不能够更换

#### 3.1.4.2 B树和B+树

数据结构示例网站

 https://www.cs.usfca.edu/~galles/visualization/Algorithms.html 

**B树图示**

B树是为了磁盘或者其他存储设备而设计的一种多叉平衡查找树（相对于二叉树，B树每个内节点有多个分叉，即多叉）

![](https://static.bigboy.fun/article/content/mysql/b+tree/20191129135227.png)

* B树的高度一般都在2~4这个高度，树的高度直接决定IO读写的次数以及查询时间复杂度（log(n)。
* B树三层可以存储bigint类型的主键10亿条。
* 如果是三层树结构---支撑的数据可以达到20G，如果是四层树结构---支撑的数据可以达到几十T。

**B树和B+树的区别**

B数据和B+树的最大区别在于非叶子节点是否存储数据的问题。

> * B树是非叶子和叶子节点都会存储数据。
> * B+树只有叶子节点才会存数据，而且存储的数据都是在一行上，而且这些数据都是有指针指向的，是有顺链表。

#### 3.1.4.3 聚集索引（InnoDB）

Cluster Index：聚簇索引（索引组织表）。

InnoDB存储引擎的数据组织方式，是聚簇索引表：完整的记录，存储在主键索引中，通过主键索引，就可以获取记录所有的列，也就是说表数据和索引是在一起，这就是聚集索引。

##### 3.1.4.3.1 主键索引

主键索引（聚集索引）的叶子节点会存储数据行，辅助索引只会存储主键值。

InnoDB要求表必须有主键（MyISAM可以没有），如果没有显示指定，则MySQL系统会自动选择一个可以唯一标识数据记录的列作为主键，如果不存在这种列，则MySQL自动为InnoDB表生成一个隐含字段作为主键，类型为长整型。

InnoDB主索引（同时也是数据文件）叶子节点包含了完整的数据记录，这种索引叫做聚集索引。

##### 3.1.4.3.2 辅助索引（次要索引）

InnoDB的所有辅助索引都引用主键作为data域，聚集索引这种实现方式使得按主键的搜索十分高效，但是辅助索引搜索需要检索两边索引：首先检索辅助索引获得主键，然后用主键到主索引中检索获得记录。

#### 3.1.4.4 非聚集索引（MyISAM）

* B+树叶子节点只会存储数据行（数据文件）的指针，简单来说数据和索引不在一起，就是非聚集索引。
* 非聚集索引中的主键索引和辅助索引都会存储指针的值

##### 3.1.4.4.1 主键索引



##### 3.1.4.4.2 辅助索引（次要索引）

在MyISAM中，主索引和辅助索引（Secondary key）在结构上没有任何区别，只是主索引要求key是唯一的，而辅助索引的key可以重复。

同样是也是一课B+Tree，data域保存数据记录的地址。因此oMyISAM中索引检索的算法为首先按照B+Tree搜索算法搜索索引，如果指定的key存在，则取出其data域的值，然后以data域的值为地址，读取响应数据记录。

### 3.1.5 组合索引的使用

#### 3.1.5.1 为什么使用组合索引？

为了节省MySQL索引存储空间以及提升搜索性能，可建立组合索引（能使用组合索引就不使用单列索引）

例如：

创建如下的一个组合索引，相当于建立了col1、col1   col1、col2

